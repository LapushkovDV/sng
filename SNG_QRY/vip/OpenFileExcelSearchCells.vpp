PROCEdURE FillInsertTables(_nrow : longint; _file : string); forward;

Function SearchCellsByName(_name: string; _nrow: longint): word;
{
  var
    _result: word;
  var
    _iCol: word;
  _result := 0;
  for (_iCol := 1; _iCol <= 512; _iCol++)
  {
    var
      _iCellStr: string;
      _iCellStr :='';
    xlGetCellValue(_nrow, _iCol, _iCellStr);
    _iCellStr := trim(_iCellStr);

    if UpCase(_iCellStr) = UpCase(_name)
    {
      _result := _iCol;
      MyLog('OK. Найдена ячейка ' + _name);
      break;
    }
  }
  result := _result
} // Functio SearchCellsByName(_name, _log : string) : byte;

Function OpenFile(_file, _listName : string; var _bookname: string): boolean;
{

  result := false;
  MyLog('Файл:  ' + _file);
  xlOpenNewExcel(false);
  xlDisplayAlerts(false);

//  if not xlcreateExcelWithTemplate(_file, false)
  if not(xlSetActiveWorkBookByName(_file))
     if not(xlOpenWorkBook(_file))
  {
    StopVisual('', 0);
    MyLog('Ошибка открытия файла ' + _file);
    Message('Ошибка открытия файла ' + _file, error);

    xlCloseWorkBook(1);
    xlKillExcel;
    Stop;     abort;    exit;
  }
  If not xlIsExcelValid
  {
    StopVisual('', 0);
    MyLog( 'Ошибка запуска EXCEL ');
//    Message('Ошибка запуска EXCEL ', error);
    xlCloseWorkBook(1);
    xlKillExcel;
    Stop;    abort;    exit;
  }

  xlGetActiveWorkBookName(_bookname);
    XLDISPLAYALERTS(false);
  if not xlSetActiveSheetByName(_listName)
  {
    StopVisual('', 0);
    MyLog('Ошибка не найден лист ' + _listName);
//    Message('Ошибка не найден лист ' + _listName, error);
    xlCloseWorkBookByName(_bookname);
    xlKillExcel;
    Stop;    abort;    exit;
  }
  result := true;
} // Functio OpenFile(_file, _listName : string) : boolean;
Function CheckFileFillValues(_file: string): boolean;
{
  result := false;
//  ClearAll;
//  StartNewVisual(vtRotateVisual, vfTimer, 'Файл: ', 1);
// LogStrTofile(_log,'Файл:  ' + _file);
  SetVisualHeader('Файл:  ' + _file
  + ''#13'' + 'Инициализация EXCEL'
+ ''#13'' + ''
  );
 // открываем файл соответствия
  var _bookname: string;

  if not OpenFile(_file, ListName, _bookname) then  {    Stop;    abort;    exit;  }

  xlSetActiveWorkBookByName(_bookname);
  xlSetActiveSheetByName(ListName);

//  var    _iCellStr: string;
  var
    Nrow: longint;
  var
    isErrorFile: boolean;
  var
    _i: longint;

  isErrorFile := false;

  Nrow := 1; // Считаем, что все находится на первой строке

  for(_i := 1; _I <= getLimit(_recArray); _i++)
  {
    if _i mod 157 = 0 then {
      setvisualHeader('Файл:  ' + _file + ''#13'' +
      'Просмотр заголовка файла, лист ' + ListName
      + ''#13'' + string(_I));
     }
    _recArray[_i].column := SearchCellsByName(_recArray[_i].def,  nrow);
    if _recArray[_i].column = 0 then
    {
      MyLog('ОШИБКА. НЕ найдена ячейка ' + _recArray[_i].def);
      isErrorFile := true;
    }
  }
  if isErrorFile
  {
    xlCloseWorkBookByName(_bookname);
    xlKillExcel;
    Stop;       abort;    exit;
  }

  Nrow := 2;
  if not isErrorFile
  {
   setvisualHeader('Файл:  ' + _file + ''#13'' +
   'Просмотр данных файла, лист ' + ListName
   + ''#13'' + ''
   );

    var r1, r2, c1, c2 : longint = 0;
    xlGetUsedRange(r1, c1, r2, c2);

    var _idMatrix : longint = xlCreateMatrixEx(r2, c2);

    xlReadMatrixFromExcelEx(_idMatrix, 1, 1, r2, c2);

    mylog('    xlGetUsedRange(r1, c1, r2, c2) ' + string(r1) + '|' + string(c1)+ '|'  + string(r2)+ '|'  + string(c2));


    /*debug
      for(_i := 1; _I <= getLimit(_recArray); _i++) {
        mylog('_recArray['+_i+'].column = ' + _recArray[_i].column)
      } // for(_i:=1; _I<= getLimit(_recArray);_i++)
      var _value : string;
     mylog('xlReadFromMatrix(3, 3, _value) = ' + xlReadFromMatrixEx(_idMatrix, 3, 3, _value));
     mylog('                       _value) = ' + _value);
    //debug end */

    for (Nrow := r1 + 1; Nrow <= r2 - r1 + 1; Nrow++)
    {
       if Nrow mod 157 = 0 then {
          setvisualHeader('Файл:  ' + _file + ''#13'' +
          'Просмотр данных файла, лист ' + ListName
               + ''#13'' + string(Nrow));
        }

      for(_i := 1; _I <= getLimit(_recArray); _i++) {
        xlReadFromMatrixEx(_idMatrix, nrow, _recArray[_i].column, _recArray[_i].value);
      } // for(_i:=1; _I<= getLimit(_recArray);_i++)
     FillInsertTables  (nrow, _file);
      //if _recArray[1].value = '' then break;
    }
   setvisualHeader('Файл:  ' + _file + ''#13'' +
   'закрываем EXCEL'
      + ''#13'' + ''
   );
   xlFreeMatrixEx(_idMatrix);
   MyLog('Обработано строк в файле: ' + String(Nrow-1));
   MyLog( '*************************************************************************************');
  } //  if not isErrorFile

  xlCloseWorkBookByName(_bookname);
  xlKillExcel;
  setvisualHeader('Файл:  ' + _file + ''#13'' +
  'Сбор данных из файла завершен'
      + ''#13'' + ''
  );

//  StopVisual('', 0);
  result := not isErrorFile

} // Functio CheckFileFillValues();
